<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Review Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        .line-clamp-3 {
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3;
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 min-h-screen p-4">

<div class="container mx-auto max-w-6xl">
    <header class="mb-8 text-center">
        <h1 class="text-4xl font-bold text-sky-400">Product Review Analyzer üõçÔ∏è</h1>
        <p class="text-slate-400 mt-2">Enter a product link to fetch, analyze, and summarize its reviews.</p>
    </header>

    <div class="bg-slate-800 shadow-2xl rounded-xl p-6 md:p-8 max-w-2xl mx-auto">
        <form id="reviewForm" class="space-y-6">
            <div>
                <label for="productLink" class="block text-sm font-medium text-slate-300 mb-1">Product Link</label>
                <input type="url" id="productLink" name="productLink"
                       class="w-full px-4 py-3 bg-slate-700 border border-slate-600 rounded-lg text-gray-100 focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none transition-colors duration-300 placeholder-slate-500"
                       placeholder="e.g., https://www.flipkart.com/..."
                       required>
            </div>
            <button type="submit" id="submitButton"
                    class="w-full flex justify-center items-center bg-sky-500 hover:bg-sky-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-50 transition-all duration-300 ease-in-out transform hover:-translate-y-0.5 active:bg-sky-700 disabled:bg-slate-600 disabled:cursor-not-allowed">
                <span id="buttonText">Fetch & Analyze Reviews</span>
                <div id="loadingIndicator" class="hidden ml-2">
                    <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
            </button>
        </form>
    </div>

    <div id="messageBox" class="mt-6 p-3 rounded-lg text-sm text-center hidden max-w-2xl mx-auto"></div>

    <div id="resultsSection" class="mt-8 grid grid-cols-1 lg:grid-cols-5 gap-8 hidden">
        <div id="summaryCard" class="lg:col-span-2 bg-slate-800 shadow-xl rounded-xl p-6 fade-in">
            <h2 class="text-2xl font-bold text-amber-400 mb-4">AI-Powered Summary</h2>
            <div id="summaryResult" class="text-slate-300 space-y-3 text-sm whitespace-pre-wrap font-mono"></div>
        </div>
        <div id="detailsCard" class="lg:col-span-3 bg-slate-800 shadow-xl rounded-xl p-6 fade-in space-y-8">
            <div id="chartsContainer" class="grid grid-cols-1 md:grid-cols-5 gap-6 items-center">
                <div class="md:col-span-2">
                    <h3 class="text-xl font-semibold text-sky-400 mb-4 text-center">Overall Sentiment</h3>
                    <div class="w-full max-w-xs mx-auto"><canvas id="overallSentimentChart"></canvas></div>
                </div>
                <div class="md:col-span-3">
                    <h3 class="text-xl font-semibold text-sky-400 mb-4 text-center">Aspect Sentiment</h3>
                    <div style="position: relative; height:250px; width:100%"><canvas id="aspectSentimentChart"></canvas></div>
                </div>
            </div>
            <div id="reviewsResult"></div>
        </div>
    </div>
</div>

<script>
    const reviewForm = document.getElementById('reviewForm');
    const submitButton = document.getElementById('submitButton');
    const buttonText = document.getElementById('buttonText');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const messageBox = document.getElementById('messageBox');
    const resultsSection = document.getElementById('resultsSection');
    const summaryResultDiv = document.getElementById('summaryResult');
    const reviewsResultDiv = document.getElementById('reviewsResult');

    let overallChart, aspectChart;

    reviewForm.addEventListener('submit', function(event) {
        event.preventDefault();
        const productLink = document.getElementById('productLink').value.trim();
        if (!productLink) { showMessage('Please enter a product link.', 'error'); return; }

        showMessage('', 'info', true);
        resultsSection.classList.add('hidden');
        buttonText.textContent = 'Fetching & Analyzing...';
        loadingIndicator.classList.remove('hidden');
        submitButton.disabled = true;
        if(overallChart) overallChart.destroy();
        if(aspectChart) aspectChart.destroy();

        const apiUrl = `http://localhost:8080/api/scrape?url=${encodeURIComponent(productLink)}`;
        fetch(apiUrl)
            .then(response => {
                if (!response.ok) throw new Error(`Server responded with status: ${response.status}`);
                return response.json();
            })
            .then(data => {
                resetUIState();
                if (!data || (!data.summary && (!data.reviewAnalyses || data.reviewAnalyses.length === 0))) {
                    showMessage(data.summary || 'No reviews or summary could be generated for this product.', 'info');
                    return;
                }

                showMessage('Successfully fetched and analyzed reviews!', 'success');
                resultsSection.classList.remove('hidden');

                summaryResultDiv.textContent = data.summary || 'AI summary could not be generated.';
                processAndRenderCharts(data.reviewAnalyses || []);
                displayReviews(data.reviewAnalyses || []);
            })
            .catch(error => {
                resetUIState();
                console.error("Fetch Error:", error);
                showMessage(`An error occurred: ${error.message}. Check console for details.`, 'error');
            });
    });

    function resetUIState() {
        buttonText.textContent = 'Fetch & Analyze Reviews';
        loadingIndicator.classList.add('hidden');
        submitButton.disabled = false;
    }

    function processAndRenderCharts(reviewAnalyses) {
        const sentimentCounts = { Positive: 0, Neutral: 0, Negative: 0 };
        const aspectData = {};

        reviewAnalyses.forEach(item => {
            const sentiment = item.overallSentiment || 'Neutral';
            sentimentCounts[sentiment] = (sentimentCounts[sentiment] || 0) + 1;

            if (item.aspectSentiments) {
                for (const [aspect, sent] of Object.entries(item.aspectSentiments)) {
                    if (!aspectData[aspect]) aspectData[aspect] = { Positive: 0, Neutral: 0, Negative: 0 };
                    aspectData[aspect][sent]++;
                }
            }
        });

        renderOverallChart(sentimentCounts);
        renderAspectChart(aspectData);
    }

    function renderOverallChart(sentimentCounts) {
        const ctx = document.getElementById('overallSentimentChart').getContext('2d');
        overallChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Positive', 'Neutral', 'Negative'],
                datasets: [{
                    data: [sentimentCounts.Positive, sentimentCounts.Neutral, sentimentCounts.Negative],
                    backgroundColor: ['#22c55e', '#facc15', '#ef4444'],
                    borderColor: '#1e293b',
                    borderWidth: 4
                }]
            },
            options: { responsive: true, plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } } }
        });
    }

    function renderAspectChart(aspectData) {
        const ctx = document.getElementById('aspectSentimentChart').getContext('2d');
        const labels = Object.keys(aspectData);
        aspectChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: 'Positive', data: labels.map(l => aspectData[l].Positive), backgroundColor: '#22c55e' },
                    { label: 'Neutral', data: labels.map(l => aspectData[l].Neutral), backgroundColor: '#facc15' },
                    { label: 'Negative', data: labels.map(l => aspectData[l].Negative), backgroundColor: '#ef4444' }
                ]
            },
            options: {
                indexAxis: 'y', responsive: true, maintainAspectRatio: false,
                scales: {
                    x: { stacked: true, ticks: { color: '#94a3b8' }, grid: { color: '#334155' } },
                    y: { stacked: true, ticks: { color: '#cbd5e1' }, grid: { display: false } }
                },
                plugins: { legend: { position: 'top', labels: { color: '#cbd5e1' } } }
            }
        });
    }

    function displayReviews(reviewAnalyses) {
        if (!reviewAnalyses || reviewAnalyses.length === 0) {
            reviewsResultDiv.innerHTML = ''; return;
        }
        let reviewsHTML = `<h3 class="text-xl font-semibold text-sky-400 mb-4 mt-6">Individual Review Details (${reviewAnalyses.length})</h3>
                           <div class="space-y-4 max-h-[400px] overflow-y-auto pr-2">`;
        reviewAnalyses.forEach((item, index) => {
            reviewsHTML += `
                <div class="p-3 bg-slate-700/80 rounded-md shadow">
                    <p class="text-slate-300 text-xs mb-2 line-clamp-3 hover:line-clamp-none transition-all duration-300 ease-in-out cursor-pointer" title="Click to expand/collapse">
                        <strong>Review #${index + 1}:</strong> ${escapeHTML(item.reviewText)}
                    </p>
                    <div class="text-xs border-t border-slate-600 pt-2 mt-2">
                        <strong class="text-slate-400">Aspects:</strong>
                        <ul class="list-disc list-inside pl-2 text-xs">`;
            if (item.aspectSentiments && Object.keys(item.aspectSentiments).length > 0) {
                for (const [aspect, sentiment] of Object.entries(item.aspectSentiments)) {
                    reviewsHTML += `<li>${escapeHTML(aspect)}: <span class="${getSentimentColor(sentiment)}">${escapeHTML(sentiment)}</span></li>`;
                }
            } else {
                reviewsHTML += `<li>No specific aspects detected.</li>`;
            }
            reviewsHTML += `</ul></div></div>`;
        });
        reviewsHTML += `</div>`;
        reviewsResultDiv.innerHTML = reviewsHTML;

        reviewsResultDiv.querySelectorAll('p[title="Click to expand/collapse"]').forEach(p => {
            p.addEventListener('click', (e) => e.target.classList.toggle('line-clamp-3'));
        });
    }

    function getSentimentColor(sentiment) {
        if (!sentiment) return 'text-slate-300';
        const s = sentiment.toLowerCase();
        if (s.includes('positive')) return 'text-green-400 font-semibold';
        if (s.includes('neutral')) return 'text-yellow-400 font-semibold';
        if (s.includes('negative')) return 'text-red-400 font-semibold';
        return 'text-slate-300';
    }

    function showMessage(message, type, hide = false) {
        messageBox.textContent = message;
        messageBox.className = 'mt-6 p-3 rounded-lg text-sm text-center';
        if (hide) { messageBox.classList.add('hidden'); return; }
        messageBox.classList.add('fade-in');
        const colorClasses = {
            error: ['bg-red-500/20', 'text-red-300'],
            success: ['bg-green-500/20', 'text-green-300'],
            info: ['bg-sky-500/20', 'text-sky-300']
        };
        messageBox.classList.add(...(colorClasses[type] || colorClasses.info));
    }

    function escapeHTML(str) {
        if (!str) return '';
        return str.toString().replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
</script>

</body>
</html>